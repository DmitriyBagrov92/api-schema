syntax = "proto3";

package dialog;


import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/api/annotations.proto";
import "definitions.proto";
import "peers.proto";
import "scalapb/scalapb.proto";

option go_package = "dialog";
option java_package = "im.dlg.grpc.services";

enum TypingType {
    TYPING_TYPE_UNKNOWN = 0;
    TYPING_TYPE_TEXT = 1;
    TYPING_TYPE_VOICE = 2;
}

// Sending typing notification
message RequestStartTyping {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    OutPeer peer = 1 [(dlg).log="visible"];
    TypingType typing_type = 2 [(dlg).log="visible"];
}

// Stop typing
message RequestStopTyping {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    OutPeer peer = 1 [(dlg).log="visible"];
    TypingType typing_type = 2 [(dlg).log="visible"];
}

enum DeviceType {
    DEVICE_TYPE_UNKNOWN = 0;
    DEVICE_TYPE_GENERIC = 1;
    DEVICE_TYPE_PC = 2;
    DEVICE_TYPE_MOBILE = 3;
    DEVICE_TYPE_TABLET = 4;
    DEVICE_TYPE_WATCH = 5;
    DEVICE_TYPE_MIRROR = 6;
    DEVICE_TYPE_CAR = 7;
    DEVICE_TYPE_TABLE = 8;
}

// Sending online state
message RequestSetOnline {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    bool is_online = 1 [(dlg).log="visible"];
    int64 timeout = 2 [(dlg).log="visible"]; /// offline after timeout
    DeviceType device_type = 3 [(dlg).log="visible"];
}

// Update about user's typing
message UpdateTyping {
    Peer peer = 1 [(dlg).log="visible"];
    string user_id = 2 [(dlg).log="visible"];
    TypingType typing_type = 3 [(dlg).log="visible"];
}

// Update about user's typing stop
message UpdateTypingStop {
    Peer peer = 1 [(dlg).log="visible"];
    string user_id = 2 [(dlg).log="visible"];
    TypingType typing_type = 3 [(dlg).log="hidden"];
}

// Update about user's last seen state
message UpdateUserLastSeen {
    string user_id = 1 [(dlg).log="visible"];
    int64 last_seen_at = 2 [(dlg).log="visible"];
    DeviceType device_type = 3;
    int64 current_server_time = 4 [(dlg).log="visible"];
}

// Update about group online change
message UpdateGroupOnline {
    string group_id = 1 [(dlg).log="visible"];
    /// amount of online users.
    int32 count = 2 [(dlg).log="visible"];
    /// The list of online users will only be sent if the flag was set during the subscription.
    repeated string users_id = 3 [(dlg).log="visible"];
}

message UpdateGroupTyping {
    message UserTyping {
        string user_id = 1 [(dlg).log="visible"];
        TypingType typing_type = 2 [(dlg).log="visible"];
    }

    string group_id = 1 [(dlg).log="visible"];
    repeated UserTyping users_typing = 2 [(dlg).log="visible"];
}

// Request for last user online timestamp
message RequestGetUserLastPresence {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    UserOutPeer user_out_peer = 1 [(dlg).log="visible"];
}

// Response for RequestGetUserLastPresence
message ResponseUserLastPresence {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    google.protobuf.Timestamp last_online_at = 1;
}

service Presence {
    rpc StartTyping (RequestStartTyping) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/grpc/Presence/StartTyping"
            body: "*"
        };
    }
    rpc StopTyping (RequestStopTyping) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/grpc/Presence/StopTyping"
            body: "*"
        };
    }
    rpc SetOnline (RequestSetOnline) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/grpc/Presence/SetOnline"
            body: "*"
        };
    }
    rpc GetUserLastPresence (RequestGetUserLastPresence) returns (ResponseUserLastPresence) {
        option (google.api.http) = {
            post: "/v1/grpc/Presence/GetUserLastPresence"
            body: "*"
        };
    }
}
