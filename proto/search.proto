syntax = "proto3";

package dialog;

// Searching API

import "timestamp.proto";
import "wrappers.proto";
import "annotations.proto";
import "definitions.proto";
import "groups.proto";
import "peers.proto";
import "messaging.proto";
import "users.proto";
import "scalapb.proto";

option go_package = "dialog";
option java_package = "im.dlg.grpc.services";

enum SearchPeerType {
    SEARCH_PEER_TYPE_UNKNOWN = 0;
    SEARCH_PEER_TYPE_GROUPS = 1;
    SEARCH_PEER_TYPE_CONTACTS = 2;
    SEARCH_PEER_TYPE_PUBLIC = 3;
}

enum SearchContentType {
    SEARCH_CONTENT_TYPE_UNKNOWN = 0;
    SEARCH_CONTENT_TYPE_ANY = 1;
    SEARCH_CONTENT_TYPE_TEXT = 2;
    SEARCH_CONTENT_TYPE_LINKS = 3;
    SEARCH_CONTENT_TYPE_DOCUMENTS = 4;
    SEARCH_CONTENT_TYPE_MEDIA = 5; // photo and video
    SEARCH_CONTENT_TYPE_AUDIO = 6; // voice
}

enum SearchDirection {
    SEARCH_DIRECTION_UNKNOWN = 0;
    SEARCH_DIRECTION_FORWARD = 1; // gt
    SEARCH_DIRECTION_BACKWARD = 2; // lt
}

enum SearchEntityType {
    SEARCH_ENTITY_UNKNOWN = 0;
    SEARCH_ENTITY_MESSAGE = 1;
    SEARCH_ENTITY_GROUP = 2;
    SEARCH_ENTITY_PROFILE = 3;
}

message SimpleContactSearchCondition {
    string text = 1;
}

message SimpleMessageSearchCondition {
    Peer peer = 1; // where to search
    string text = 2; // search term
    SearchContentType type = 3; // content message type to search
    SearchDirection search_direction = 4; // search direction gt/lt
    google.protobuf.Int64Value date_from = 5; // search message from
    Peer sender = 6; // only search messages from specific sender
}

/// Search among contacts/groups/users
message SimplePeerSearchCondition {
    SearchPeerType peer_type = 1;
    google.protobuf.StringValue text = 2;
}

message SimpleUserProfileSearchCondition {
    string query_string = 1;
}

message SimpleGroupSearchCondition {
    string query_string = 1;
}

message SimpleSearchCondition {
    oneof criterion {
        SimpleContactSearchCondition contact = 1;
        SimpleMessageSearchCondition message = 2;
        SimplePeerSearchCondition peer = 3;
        SimpleUserProfileSearchCondition user_profile = 4;
        SimpleGroupSearchCondition group = 5;
    }
}

message SearchCondition {
    oneof body {
        SearchPeerTypeCondition search_peer_type_condition = 1;
        SearchPieceText search_piece_text = 2;
        SearchAndCondition search_and_condition = 3;
        SearchOrCondition search_or_condition = 4;
        SearchPeerCondition search_peer_condition = 5;
        SearchPeerContentType search_peer_content_type = 6;
        SearchSenderIdCondition search_sender_id_condition = 7;
        SearchUserCondition search_user_condition = 8;
    }
}

// Search AND condion
message SearchAndCondition {
    /// "And" query
    repeated SearchCondition and_query = 1;
}

// Search OR condition
message SearchOrCondition {
    /// "Or" query
    repeated SearchCondition or_query = 1;
}

// Search peer type condition
message SearchPeerTypeCondition {
    SearchPeerType peer_type = 1;
}

// Search peer name condition
message SearchPieceText {
    string query = 1 [(dlg).log=log_sensitive];
}

// Search Peer condition
message SearchPeerCondition {
    OutPeer peer = 1;
}

// Search content type condition
message SearchPeerContentType {
    SearchContentType content_type = 1;
}

message SearchUserCondition {
    message ExtensionCondition {
        oneof condition {
            string string_value_equality = 1;
            bool bool_value_equality = 2;
            bool value_existence = 3;
            bool value_absence = 4;
        }
    }
    google.protobuf.BoolValue is_bot = 1;
    map<string, ExtensionCondition> extension_conditions = 2; /// map of extension key -> condition
}

// Searching sender uid condition
message SearchSenderIdCondition {
    string sender_id = 1;
}

// Peer search result
message PeerSearchResult {
    Peer peer = 1;
    string title = 2 [(dlg).log=log_sensitive];
    google.protobuf.StringValue shortname = 3;
    google.protobuf.StringValue description = 4 [(dlg).log=log_sensitive];
    google.protobuf.Int32Value members_count = 5;
    /// Group Creation Date
    int64 date_created = 6;
    google.protobuf.StringValue creator = 7;
    google.protobuf.BoolValue is_public = 8;
    /// Are you joined?
    google.protobuf.BoolValue is_joined = 9;
}

// Performing peer search
message RequestPeerSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    repeated SearchCondition query = 1;
}

/// Response with related peers and entities
message ResponsePeerSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";

    repeated PeerSearchResult search_results = 1;
    repeated UserOutPeer user_peers = 2;
    repeated GroupOutPeer group_peers = 3;
}

// Resolve peer by shortname
message RequestResolvePeer {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    string shortname = 1;
}

message ResponseResolvePeer {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    OutPeer peer = 1;
}

message FacetHighlight {
    string text = 1;
    int32 highlight_start_pos = 2;
    int32 highlight_end_pos = 3;
}

message UserSearchResult {
    UserOutPeer peer = 1;
    google.protobuf.Timestamp last_online_at = 2;
    repeated FacetHighlight facet_highlights = 3;
    map<string, string> metadata = 4;
}

message GroupSearchResult {
    GroupOutPeer peer = 1;
    repeated FacetHighlight facet_highlights = 2;
}

message ContactSearchResult {
    string phone_hash = 1;
    google.protobuf.StringValue user_id = 2;
    repeated FacetHighlight facet_highlights = 3;
}

// Message container
message MessageSearchResult {
    Peer peer = 1;
    reserved 2; reserved "rid";
    int64 date = 3;
    string sender_id = 4;
    MessageContent content = 5;
    UUIDValue mid = 6;
    reserved 7; reserved "highlight_tokens";
    repeated FacetHighlight facet_highlights = 8;
}

message SearchResult {
    oneof body {
        ContactSearchResult contact_search_result = 1;
        UserSearchResult user_search_result = 2;
        GroupSearchResult group_search_result = 3;
        MessageSearchResult message_search_result = 4;
    }
}

// Message Search result container
message MessageSearchItem {
    MessageSearchResult result = 1;
}

// Search Result with related peers and entities
message ResponseMessageSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    repeated MessageSearchItem search_results = 1;
    google.protobuf.BytesValue load_more_state = 2;
    repeated UserOutPeer user_out_peers = 3;
    repeated GroupOutPeer group_out_peers = 4;
    int64 total_count = 5;
}

// Search Result with related user and group entities
message ResponseSimpleSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    reserved 1;
    google.protobuf.BytesValue load_more_state = 2;
    repeated UserSearchResultItem users = 3;
    repeated GroupSearchResultItem groups = 4;
    int64 total_count = 5;
}

message UserSearchResultItem {
    UserOutPeer peer = 1;
    string name = 2;
    google.protobuf.StringValue avatar_url = 3;
    map<string, HighlightResult> highlights = 4;
}

message GroupSearchResultItem {
    string id = 1;
    string title = 2;
    google.protobuf.StringValue avatar_url = 3;
    bool is_member = 4;
    int32 member_count = 5;
    map<string, HighlightResult> highlights = 6;
}

message HighlightToken {
    string value = 1;
}

message HighlightResult {
    repeated HighlightToken tokens = 1;
}

// Performing message search
message RequestMessageSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    SearchCondition query = 1;
}

// Performing message search paging
message RequestMessageSearchMore {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    bytes load_more_state = 1; /// Cursor
}

message RequestSimpleSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    repeated SimpleSearchCondition criteria = 1;
    google.protobuf.Int32Value limit = 2;
}

message RequestSimpleSearchMore {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    bytes load_more_state = 1; /// Cursor
    google.protobuf.Int32Value limit = 2;
}

message RequestAutocompleteSuggestions {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    string field_name = 1;
    string field_value = 2;
}

message ResponseAutocompleteSuggestions {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    string field_name = 1;
    repeated string field_value = 2;
}

message RequestLoadUserSearchByPredicatesResults {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    repeated SearchPredicate predicates = 1;
    string group_id = 2;
    google.protobuf.StringValue query = 3;
    int32 limit = 4;
    repeated string required_fields = 5;
}

message UserMatch {
    string user_id = 1;
    bool match_predicates = 2;
}

message ResponseLoadUserSearchByPredicatesResults {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    repeated UserMatch users = 1;
    int32 result_count = 2;
}

message RequestLoadUserSearchByPredicatesCount {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    repeated SearchPredicate predicates = 1;
    string group_id = 2;
}


message ResponseLoadUserSearchByPredicatesCount {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    int32 result_count = 1;
}

message RequestGetRecommendations {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
}

message ResponseGetRecommendations {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    repeated OutPeer peers = 1;
}

message RequestGetPromotedPeers {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
}

message ResponseGetPromotedPeers {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    repeated UserOutPeer user_peers = 1;
    repeated GroupOutPeer group_peers = 2;
}

message RequestSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    string query = 1;
    int32 limit = 2;
    google.protobuf.BytesValue cursor = 3;
    SearchCondition condition = 4;
}

message ResponseSearch {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    repeated SearchResult search_results = 1;
    map<string, UserData> user_data = 2;
    map<string, GroupData> group_data = 3;
    google.protobuf.BytesValue next_cursor = 4;
}

service Search {
    /// Search among groups/users/contacts
    rpc PeerSearch (RequestPeerSearch) returns (ResponsePeerSearch) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/PeerSearch"
            body: "*"
        };
    }

    rpc ResolvePeer (RequestResolvePeer) returns (ResponseResolvePeer) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/ResolvePeer"
            body: "*"
        };
    }

    /// Search by messages
    rpc MessageSearch (RequestMessageSearch) returns (ResponseMessageSearch) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/MessageSearch"
            body: "*"
        };
    }

    rpc MessageSearchMore (RequestMessageSearchMore) returns (ResponseMessageSearch) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/MessageSearchMore"
            body: "*"
        };
    }

    /// Custom search by conditions
    rpc SimpleSearch (RequestSimpleSearch) returns (ResponseSimpleSearch) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/SimpleSearch"
            body: "*"
        };
    }
    rpc SimpleSearchMore (RequestSimpleSearchMore) returns (ResponseSimpleSearch) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/SimpleSearchMore"
            body: "*"
        };
    }

    /// Search for autocomplete suggestions among custom user profile
    rpc AutocompleteSuggestions (RequestAutocompleteSuggestions) returns (ResponseAutocompleteSuggestions) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/AutocompleteSuggestions"
            body: "*"
        };
    }

    rpc LoadUserSearchByPredicatesResults (RequestLoadUserSearchByPredicatesResults) returns (ResponseLoadUserSearchByPredicatesResults) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/LoadUserSearchByPredicatesResults"
            body: "*"
        };
    }

    rpc LoadUserSearchByPredicatesCount (RequestLoadUserSearchByPredicatesCount) returns (ResponseLoadUserSearchByPredicatesCount) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/LoadUserSearchByPredicatesCount"
            body: "*"
        };
    }

    rpc GetRecommendations (RequestGetRecommendations) returns (ResponseGetRecommendations) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/GetRecommendations"
            body: "*"
        };
    }

    rpc GetPromotedPeers (RequestGetPromotedPeers) returns (ResponseGetPromotedPeers) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/GetDiscovery"
            body: "*"
        };
    }

    rpc Search (RequestSearch) returns (ResponseSearch) {
        option (google.api.http) = {
            post: "/v1/grpc/Search/Search"
            body: "*"
        };
    }
}
