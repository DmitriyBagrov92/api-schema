syntax = "proto3";

package dialog;

import "wrappers.proto";
import "empty.proto";
import "annotations.proto";
import "definitions.proto";
import "miscellaneous.proto";
import "authentication.proto";
import "groups.proto";
import "stickers.proto";
import "presence.proto";
import "config_sync.proto";
import "contacts.proto";
import "privacy.proto";
import "peers.proto";
import "messaging.proto";
import "users.proto";
import "threads.proto";
import "reactions.proto";
import "permissions.proto";
import "scalapb.proto";
import "miniappsregistry.proto";
import "suggests.proto";
import "drafts.proto";

option go_package = "dialog";
option java_package = "im.dlg.grpc.services";


/// Структура тела сек-апдейта
message SeqUpdateBody {
    reserved 28, 33, 40, 44, 50, 52, 53, 58, 59, 62, 65, 71, 72;
    /// Вид сек-апдейта
    oneof update {
        UpdateUserAvatarChanged update_user_avatar_changed = 1;
        UpdateUserNameChanged update_user_name_changed = 2;
        UpdateUserLocalNameChanged update_user_local_name_changed = 3;
        UpdateUserContactsChanged update_user_contacts_changed = 4;
        UpdateUserNickChanged update_user_nick_changed = 5;
        UpdateUserAboutChanged update_user_about_changed = 6;
        UpdateUserPreferredLanguagesChanged update_user_preferred_languages_changed = 7;
        UpdateUserTimeZoneChanged update_user_time_zone_changed = 8;
        UpdateUserBotCommandsChanged update_user_bot_commands_changed = 9;
        UpdateUserExtChanged update_user_ext_changed = 10;
        UpdateUserFullExtChanged update_user_full_ext_changed = 11;
        UpdateUserSexChanged update_user_sex_changed = 12;
        UpdateUserCustomProfileChanged update_user_custom_profile_changed = 13;
        UpdateUserStatusChanged update_user_status_changed = 14;
        UpdateContactRegistered update_contact_registered = 15;
        UpdateContactsAdded update_contacts_added = 16;
        UpdateContactsAddTaskSuspended update_contacts_add_task_suspended = 17;
        UpdateContactsRemoved update_contacts_removed = 18;
        UpdateUserBlocked update_user_blocked = 19;
        UpdateUserUnblocked update_user_unblocked = 20;
        UpdateInteractiveMediaEvent update_interactive_media_event = 21;
        UpdateMessage update_message = 22;
        UpdateMessageContentChanged update_message_content_changed = 23;
        UpdateMessageSent update_message_sent = 24;
        UpdateMessageReceived update_message_received = 25;
        UpdateMessageRead update_message_read = 26;
        UpdateMessageReadByMe update_message_read_by_me = 27;
        UpdateChatClear update_chat_clear = 29;
        UpdateChatDelete update_chat_delete = 30;
        UpdateChatArchive update_chat_archive = 31;
        UpdateChatGroupsChanged update_chat_groups_changed = 32;
        UpdateDialogFavouriteChanged update_dialog_favourite_changed = 34;
        UpdatePinnedMessagesChanged update_pinned_messages_changed = 35;
        UpdateGroupTitleChanged update_group_title_changed = 36;
        UpdateGroupAvatarChanged update_group_avatar_changed = 37;
        UpdateGroupAboutChanged update_group_about_changed = 38;
        UpdateGroupOwnerChanged update_group_owner_changed = 39;
        UpdateGroupMemberDiff update_group_member_diff = 41;
        UpdateGroupMembersCountChanged update_group_members_count_changed = 42;
        UpdateGroupMemberPermissionsChanged update_group_member_permissions_changed = 43;
        UpdateStickerCollectionsChanged update_sticker_collections_changed = 45;
        UpdateStickerPackRemoved update_sticker_pack_removed = 46;
        UpdateStickerPackAdded update_sticker_pack_added = 47;
        UpdateParameterChanged update_parameter_changed = 48;
        UpdateRawUpdate update_raw_update = 49;
        UpdateConfig update_config = 51;
        UpdateSendMessageError update_send_message_error = 54;
        UpdateEditMessageError update_edit_message_error = 55;
        UpdateUser update_user = 56;
        UpdateFeatureFlagChanged update_feature_flag_changed = 57;
        UpdateGroup update_group = 60;
        UpdateGroupMemberInvited update_group_member_invited = 61;
        UpdatePermissionsChange update_permissions_change = 63;
        UpdateGroupTyping update_group_typing = 64;
        UpdateDialogMuteChanged update_dialog_mute_changed = 66;
        UpdateSettingsChanged update_settings_changed = 67;
        UpdateDeleteMessageError update_delete_message_error = 68;
        UpdateMessageReadError update_message_read_error = 69;
        UpdateMessageReceivedError update_message_received_error = 70;
        UpdateClearChatError update_clear_chat_error = 73;
        UpdateDeleteChatError update_delete_chat_error = 74;
        UpdateFavouriteDialogError update_favourite_dialog_error = 75;
        UpdateUnfavouriteDialogError update_unfavourite_dialog_error = 76;
        UpdateReadDialogLaterError update_read_dialog_later_error = 77;
        UpdateThreadFollowing update_thread_following = 78;
        UpdateFoldersList update_folders_list = 79;
        UpdateFolderAssignments update_folder_assignment = 80;
        UpdateGroupBasePermissionsChanged update_group_base_permissions_changed = 81;
    }
}

/// Структура сек-апдейта
message SeqUpdate {
    /// Порядковый номер сек-апдейта
    uint64 seq = 1;

    /// Тело сек-апдейта
    SeqUpdateBody body = 2;
}

/// Запрос на полчение разницы в сек-апдейтах между клиентом и сервером
message RequestGetDifference {
    /// Порядковый номер, с которого (не включая его) необходимо получить недостающие апдейты
    uint64 seq = 1;

    /// deprecated
    google.protobuf.Int64Value config_hash = 2 [deprecated=true];
}

/// Ответ на запрос на полчение разницы в сек-апдейтах между клиентом и сервером
message ResponseGetDifference {
    /// Последний порядковый номер в ответе
    uint64 seq = 1;
    
    /// Список апдейтов
    repeated SeqUpdate updates = 2;

    /// Флаг, определяющий что на полученные в списке апдейты не исчерпывают разницы между клиентом и сервером 
    /// и необходимо сделать повторный запрос на получение разницы после применения полученного списка (уже с новым seq-номером в запросе)
    bool need_more = 4;

    reserved 3,5,6,7,8;

    /// Текущий минимальный сек-номер апдейта на момент запроса
    uint64 min_seq = 9;
}

/// Подмножетсво членов группового чата
message GroupMembersSubset {
    /// Внешний пир группового чата [здесь достаточно group_id]
    reserved 1;
    string group_id = 3;

    /// Список идентификаторов учетных записей пользователей-членов группового чата
    repeated string member_ids = 2;
}

/// Запрос на дополнительных загрузку сущностей
message RequestGetReferencedEntities {
    /// Список внешний пиров пользователей для загрузки
    repeated UserOutPeer users = 1;
    
    /// Список идфентификаторов сообщений для загрузки
    /// deprecated
    repeated UUIDValue mids = 2;
    
    /// Список подмножеств членов групповых чатов 
    repeated GroupMembersSubset group_members = 3;
    
    /// Список внешний пиров групп [тут достаточно group_id]
    /// deprecated
    repeated GroupOutPeer groups = 4 [deprecated = true];

    /// Список идфентификаторов сообщений для загрузки
    repeated ReferencedMessages referenced_mids = 5;

    repeated string group_ids = 6;
}

/// Ответ на запрос на дополнительных загрузку сущностей
message ResponseGetReferencedEntities {
    /// Список данных о пользователях
    repeated User users = 1;

    /// Список данных о группах
    repeated Group groups = 2;

    /// Список сообщений
    repeated HistoryMessage messages = 3;
}

/// deprecated
message RequestGetPartialPeerInfo {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcRequest";
    repeated UserOutPeer users = 1;
    reserved 2;
    repeated string group_ids = 4;
    repeated GroupMembersSubset group_members = 3;
}

/// deprecated
message ResponseGetPartialPeerInfo {
    option (scalapb.message).extends = "im.dlg.grpc.GrpcResponse";
    repeated UserPartialInfo users = 1;
    repeated GroupPartialInfo groups = 2;
}

// Структура уведомления о событии без явного типа апдейта, используется для передачи апдейтов от внешних систем
message UpdateRawUpdate {
    google.protobuf.StringValue type = 1;
    bytes bytes = 2;
}

/// Список пиров
message PeersList {
    repeated Peer peers = 1;
}

/// Команда для weak-стрима
message WeakUpdateCommand {
    /// Команда на изменение статуса онлайна текущего пользователя
    message ChangeMyOnline {
        /// Флаг, определяющий состояние онлайна
        bool online = 1;

        /// Время в миллисекундах, через которое этот статус утратит своё действие.
        /// Действует только, если online == true
        int64 timeout = 2;

        /// Тип устройства пользователя
        DeviceType device_type = 3;
    }

    /// Команда подписки на статусы онлайнов в чатах
    message SubscribeToOnlines {
        /// Список пиров, статусы в которых необходимо доводить до клиента в рамках текущего weak-стрима
        PeersList peers = 1;

        /// Досылать ли список идентификаторов учетных записей пользователей в статусах групповых чатов
        bool send_users_id = 2;
    }

    /// Команда на изменение статуса тайпинга текущего пользователя
    message ChangeMyTyping {
        /// Пир чата, в котором происходит смена статуса тайпинга
        Peer peer       = 1;

        /// Тип тайпинга
        TypingType type = 2;

        /// Флаг начала тайпинга
        bool start      = 3;
    }

    oneof command {
        /// Команда на изменение статуса онлайна текущего пользователя
        ChangeMyOnline change_my_online                    = 1;

        /// Команда подписки на статусы онлайнов других пользователей
        SubscribeToOnlines subscribe_to_onlines            = 2;

        /// Команда отписки от статусов онлайнов других пользователей
        PeersList unsubscribe_from_onlines                 = 3;

        /// Команда отписки от всех статусов онлайнов
        google.protobuf.Empty unsubscribe_from_all_onlines = 4;

        /// Команда на изменение статуса тайпинга текущего пользователя
        ChangeMyTyping change_my_typing                    = 5;

        /// Команда подписки на статусы тайпингов других пользователей
        PeersList subscribe_to_typings                     = 6;

        /// Команда отписки от статусов тайпингов других пользователей
        PeersList unsubscribe_from_typings                 = 7;

        /// Команда отписки от всех статусов тайпингов
        google.protobuf.Empty unsubscribe_from_all_typings = 8;
    }
}

/// Структура weak-уведомления
message WeakUpdate {
    /// Уведомление о необходимости сброса частей состояния клиентского приложеиня
    message UpdateForceReloadState {
        message ForceReloadField {
            oneof field {
                google.protobuf.Empty reload_dialogs  = 1;
                google.protobuf.Empty reload_contacts = 2;
                PeersList reload_history              = 3;
            }
        }
        repeated ForceReloadField fields = 1;
    }

    reserved 6, 9, 10, 11, 12, 13, 17, 25;

    oneof updatebox {
        UpdateTyping typing                                                   = 1;
        UpdateTypingStop typing_stop                                          = 2;
        UpdateUserLastSeen user_last_seen                                     = 3;
        UpdateGroupOnline group_online                                        = 4;
        UpdateForceReloadState force_reload                                   = 5;
        UpdateUserStatusChanged user_status_change                            = 7;
        UpdateMessageReactions message_reaction_update                        = 8;
        UpdateGroupTyping group_typing                                        = 15;
        UpdateMiniApp mini_app                                                = 16;
        UpdateContactRegistered update_contact_registered                     = 18;
        UpdateContactsAdded update_contacts_added                             = 19;
        UpdateContactsAddTaskSuspended update_contacts_add_task_suspended     = 20;
        UpdateContactsRemoved update_contacts_removed                         = 21;
        UpdateSuggests update_suggests                                        = 22;
        UpdateFeatureFlagChanged update_feature_flag_changed                  = 23;
        UpdateDraftsChanged update_drafts_changed                             = 24;
        UpdateThreadInfos update_thread_infos                                 = 26;
    }
}

/// Запрос на получение текущего состояния потока seq-апдейтов пользователя
message RequestGetState {}

/// Ответ на запрос на получение текущего состояния потока seq-апдейтов пользователя
message ResponseGetState {
    /// Текущий последний сек-номер апдейта в потоке пользователя на момент запроса
    uint64 seq = 1;
    reserved 2;
}

service SequenceAndUpdates {
    /// Метод получения текущего состояния потока seq-апдейтов пользователя
    rpc GetState(RequestGetState) returns (ResponseGetState) {
        option (google.api.http) = {
            post: "/v1/grpc/SequenceAndUpdates/GetState"
            body: "*"
        };
    }

    /// Метод полчения разницы в сек-апдейтах между клиентом и сервером
    rpc GetDifference (RequestGetDifference) returns (ResponseGetDifference) {
        option (google.api.http) = {
            post: "/v1/grpc/SequenceAndUpdates/GetDifference"
            body: "*"
        };
    }
    
    /// Метод загрузки дополнительных сущностей
    rpc GetReferencedEntities (RequestGetReferencedEntities) returns (ResponseGetReferencedEntities) {
        option (google.api.http) = {
            post: "/v1/grpc/SequenceAndUpdates/GetReferencedEntitites"
            body: "*"
        };
    }

    /// deprecated
    rpc GetPartialPeerInfo (RequestGetPartialPeerInfo) returns (ResponseGetPartialPeerInfo) {}

    /// Метод открытия подписки на поток сек-апдейтов пользователя
    rpc SeqUpdates (google.protobuf.Empty) returns (stream SeqUpdate) {
        option (google.api.http) = {
            post: "/v1/grpc/SequenceAndUpdates/SeqUpdates"
            body: "*"
        };
    }

    /// Метод открытия подписки на поток weak-апдейтов пользователя
    rpc WeakUpdates (google.protobuf.Empty) returns (stream WeakUpdate) {
        option (google.api.http) = {
            post: "/v1/grpc/SequenceAndUpdates/WeakUpdates"
            body: "*"
        };
    }
}
